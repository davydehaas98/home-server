services:
  # Open source code quality and security tool
  sonarqube:
    image: sonarqube:10.6.0-community@sha256:72e9feec71242af83faf65f95a40d5e3bb2822a6c3b2cda8568790f3d31aecde
    container_name: sonarqube
    restart: unless-stopped
    user: ${UID}:${GID}
    environment:
    - TZ=${TZ}
    - sonar.jbdc.username=sonarqube
    - sonar.jbdc.password=sonarqube
    - sonar.jdbc.url=jdbc:postgresql://sonarqube-postgresql:5432/sonarqube
    volumes:
    - ${USER_DIR}/sonarqube/bundled-plugins:/opt/sonarqube/lib/bundled-plugins
    - ${USER_DIR}/sonarqube/config:/opt/sonarqube/conf
    - ${USER_DIR}/sonarqube/data:/opt/sonarqube/data
    - ${USER_DIR}/sonarqube/extensions:/opt/sonarqube/extensions
    - ${USER_DIR}/sonarqube/logs:/opt/sonarqube/logs
    - ${USER_DIR}/sonarqube/temp:/opt/sonarqube/temp
    expose:
    - 9000
    - 9092 # Embedded H2 database
    labels:
    - com.centurylinklabs.watchtower.enable=true
    - diun.enable=true
    - diun.watch_repo=true
    depends_on:
    - sonarqube-postgresql
    stop_grace_period: 2m30s
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535

  # PostgreSQL database used by SonarQube
  sonarqube-postgresql:
    image: postgres:16.4@sha256:026d0ab72b34310b68160ab9299aa1add5544e4dc3243456b94f83cb1c119c2c
    container_name: sonarqube-postgresql
    restart: unless-stopped
    user: ${UID}:${GID}
    environment:
    - TZ=${TZ}
    - POSTGRES_USER=sonarqube
    - POSTGRES_PASSWORD=sonarqube
    - POSTGRES_DB=sonarqube
    volumes:
    - ${STORAGE_DIR}/sonarqube-postgresql:/var/lib/postgresql
    # This needs explicit mapping due to https://github.com/docker-library/postgres/blob/4e48e3228a30763913ece952c611e5e9b95c8759/Dockerfile.template#L52
    - ${STORAGE_DIR}/sonarqube-postgresql/data:/var/lib/postgresql/data
    labels:
    - com.centurylinklabs.watchtower.enable=true
    - diun.enable=true
    - diun.watch_repo=true
    shm_size: 256M
  